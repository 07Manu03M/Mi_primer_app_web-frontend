<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        header {
            background: #4CAF50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        main {
            padding: 1.5rem;
        }

        .btn {
            padding: 0.7rem 1rem;
            margin: 0.3rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 400px;
            text-align: center;
        }

        input,
        textarea {
            width: 100%;
            margin: 0.5rem 0;
            padding: 0.7rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .task-card {
            background: white;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <header>
        <h1>Bienvenido</h1>
    </header>

    <main>
        <div id="user-info"></div>
        <button class="btn btn-primary" id="crearTareaBtn">Crear tarea</button>
        <button class="btn btn-secondary" id="crearGrupoBtn">Crear grupo</button>
        <button class="btn btn-danger" id="logout">Cerrar sesiÃ³n</button>

        <h2>Mis tareas</h2>
        <div id="tareas-list"></div>
    </main>

    <!-- Modal Crear Tarea -->
    <div id="modalTarea" class="modal">
        <div class="modal-content">
            <h3>Crear Tarea</h3>
            <input type="text" id="titulo" placeholder="TÃ­tulo" required>
            <textarea id="descripcion" placeholder="DescripciÃ³n" required></textarea>
            <input type="date" id="fechaLimite" required>
            <button class="btn btn-primary" onclick="enviarTarea()">Guardar</button>
            <button class="btn btn-danger" onclick="cerrarModal('modalTarea')">Cancelar</button>
        </div>
    </div>


    <!-- Modal Crear Grupo -->
    <div id="modalGrupo" class="modal">
        <div class="modal-content">
            <h3>Crear Grupo</h3>
            <input type="text" id="nombreGrupo" placeholder="Nombre del grupo" required>
            <textarea id="descripcionGrupo" placeholder="DescripciÃ³n" required></textarea>
            <button class="btn btn-primary" onclick="enviarGrupo()">Guardar</button>
            <button class="btn btn-danger" onclick="cerrarModal('modalGrupo')">Cancelar</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "./login.html";

        let userId = null;

        // ðŸ”¹ FunciÃ³n para manejar respuestas
        async function handleResponse(res) {
            if (res.status === 401) {
                localStorage.removeItem("token");
                window.location.href = "./login.html";
                throw new Error("No autorizado. Redirigiendo...");
            }
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.msg || "Error en la peticiÃ³n");
            }
            return res.json();
        }

        // Decodificar token
        try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            userId = payload.id;

            fetch(`http://localhost:4000/api/usuarios/${userId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            })
                .then(handleResponse)
                .then(usuario => {
                    document.getElementById("user-info").innerHTML = `
                        <h2>Hola, ${usuario.nombre} ðŸ‘‹</h2>
                        <p><strong>Email:</strong> ${usuario.email}</p>
                    `;
                    listarTareas();
                })
                .catch(err => console.error(err.message));
        } catch (err) {
            localStorage.removeItem("token");
            window.location.href = "./login.html";
        }

        // Botones
        document.getElementById("crearTareaBtn").onclick = () => abrirModal("modalTarea");
        document.getElementById("crearGrupoBtn").onclick = () => abrirModal("modalGrupo");
        document.getElementById("logout").onclick = () => {
            localStorage.removeItem("token");
            window.location.href = "./login.html";
        };

        // Funciones Modal
        function abrirModal(id) {
            document.getElementById(id).style.display = "flex";
        }
        function cerrarModal(id) {
            document.getElementById(id).style.display = "none";
        }

        // Enviar nueva tarea
        function enviarTarea() {
            const data = {
                titulo: document.getElementById("titulo").value,
                descripcion: document.getElementById("descripcion").value,
                fechaLimite: document.getElementById("fechaLimite").value,
                responsable: userId  // ðŸ‘ˆ el usuario logueado
            };

            fetch("http://localhost:4000/api/tareas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(data)
            })
                .then(handleResponse)
                .then(() => {
                    cerrarModal("modalTarea");
                    listarTareas();
                })
                .catch(err => console.error(err.message));
        }


        // Enviar nuevo grupo
        function enviarGrupo() {
            const data = {
                nombre: document.getElementById("nombreGrupo").value,
                descripcion: document.getElementById("descripcionGrupo").value,
            };

            fetch("http://localhost:4000/api/grupos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(data)
            })
                .then(handleResponse)
                .then(() => {
                    cerrarModal("modalGrupo");
                    alert("Grupo creado âœ…");
                })
                .catch(err => console.error(err.message));
        }

        // Listar tareas
        function listarTareas() {
            fetch(`http://localhost:4000/api/tareas/${userId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            })
                .then(handleResponse)
                .then(tareas => {
                    const lista = document.getElementById("tareas-list");
                    lista.innerHTML = "";
                    tareas.forEach(t => {
                        lista.innerHTML += `
                            <div class="task-card">
                                <h3>${t.titulo}</h3>
                                <p>${t.descripcion}</p>
                                <p><strong>Fecha lÃ­mite:</strong> ${new Date(t.fechaLimite).toLocaleDateString()}</p>
                                <p><strong>Responsable:</strong> ${t.responsable?.nombre || "N/A"}</p>
                            </div>
                        `;
                    });
                })
                .catch(err => console.error(err.message));
        }
    </script>
</body>

</html>
<!--aaa